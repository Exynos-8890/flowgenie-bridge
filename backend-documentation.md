
# Flowsmith 后端技术文档

## 技术栈概览

Flowsmith 后端系统采用以下技术栈：

- **Node.js** - JavaScript 运行环境
- **Express** - Web 服务器框架
- **LowDB** - 轻量级 JSON 数据库
- **UUID** - 生成唯一标识符
- **CORS** - 跨域资源共享
- **Concurrently** - 同时运行多个命令（前端和后端）

## 系统架构

### 1. 后端架构

```
[Frontend App] <-----> [Express API Server] <-----> [LowDB JSON Database]
```

后端服务器采用 Express.js 构建，提供 RESTful API 接口。数据存储使用 LowDB，这是一个基于 JSON 文件的轻量级数据库，适合中小型应用和原型开发。

### 2. 数据模型

数据库设计包含以下主要集合：

- **flows** - 存储流程的基本信息
  - id: 唯一标识符
  - name: 流程名称
  - description: 流程描述
  - createdAt: 创建时间
  - updatedAt: 更新时间

- **nodes** - 存储流程图中的节点
  - id: 节点唯一标识符
  - flowId: 所属流程ID
  - type: 节点类型（text/processor）
  - position: 节点在画布中的位置
  - data: 节点数据（包含内容、标签等）

- **edges** - 存储节点之间的连接
  - id: 连接唯一标识符
  - flowId: 所属流程ID
  - source: 源节点ID
  - target: 目标节点ID
  - sourceHandle: 源节点连接点（可选）
  - targetHandle: 目标节点连接点（可选）

## API 接口文档

### 流程管理

#### 1. 获取所有流程
- **URL**: `/api/flows`
- **方法**: GET
- **响应**: 所有流程的数组
- **用途**: 获取用户创建的所有流程列表

#### 2. 创建新流程
- **URL**: `/api/flows`
- **方法**: POST
- **请求体**:
  ```json
  {
    "name": "流程名称",
    "description": "流程描述（可选）"
  }
  ```
- **响应**: 新创建的流程对象
- **用途**: 创建一个新的空流程

#### 3. 获取特定流程
- **URL**: `/api/flows/:id`
- **方法**: GET
- **响应**: 包含流程信息、节点和连接的对象
- **用途**: 获取特定流程的所有数据

#### 4. 更新流程
- **URL**: `/api/flows/:id`
- **方法**: PUT
- **请求体**:
  ```json
  {
    "name": "新名称",
    "description": "新描述"
  }
  ```
- **响应**: 更新后的流程对象
- **用途**: 更新流程的基本信息

#### 5. 删除流程
- **URL**: `/api/flows/:id`
- **方法**: DELETE
- **响应**: 204 No Content
- **用途**: 删除特定流程及其所有相关数据

#### 6. 保存流程图
- **URL**: `/api/flows/:id/save`
- **方法**: POST
- **请求体**:
  ```json
  {
    "nodes": [节点数组],
    "edges": [连接数组]
  }
  ```
- **响应**: 保存结果消息和更新的数据
- **用途**: 保存整个流程图（节点和连接）

### 处理器执行

#### 1. 执行处理器
- **URL**: `/api/processors/execute`
- **方法**: POST
- **请求体**:
  ```json
  {
    "processorId": "处理器节点ID",
    "inputNodes": ["输入节点ID数组"],
    "outputNodeId": "输出节点ID"
  }
  ```
- **响应**: 
  ```json
  {
    "success": true,
    "result": "处理结果",
    "outputNodeId": "输出节点ID"
  }
  ```
- **用途**: 执行处理器节点，处理输入节点的内容并更新输出节点

## 存储逻辑与数据流

### 流程图存储

1. **初始创建**:
   - 用户创建一个新流程，系统分配唯一ID
   - 可以选择从默认模板创建或空白创建

2. **添加/编辑节点**:
   - 用户添加或编辑节点时，前端临时存储状态
   - 点击保存或自动保存触发，将整个流程图状态发送到后端

3. **保存时的数据处理**:
   - 后端接收节点和连接数据
   - 将每个节点和连接关联到特定流程
   - 替换该流程的所有现有节点和连接
   - 更新流程的时间戳

### 处理器执行流程

1. **请求处理**:
   - 前端识别处理器节点的输入和输出
   - 发送处理请求到后端API

2. **后端处理**:
   - 收集输入节点的内容
   - 根据处理器类型和模板执行相应处理
   - 将结果更新到输出节点
   - 返回处理结果给前端

3. **前端更新**:
   - 接收处理结果
   - 更新本地状态中的输出节点
   - 提示用户处理完成

## 部署信息

Flowsmith 后端系统使用 Docker 容器化，可以方便地部署在各种环境中。Docker 配置已在项目根目录的 Dockerfile 中设置。

### 环境变量

系统支持以下环境变量配置：

- `API_PORT`: API 服务器端口（默认: 3001）
- `NODE_ENV`: 环境设置（development/production）

### 数据持久化

数据存储在 Docker 容器内的 `/usr/src/app/data` 目录中。在生产环境中，建议将此目录映射到主机卷以确保数据持久化。

## 安全性考虑

当前实现主要用于原型开发和概念验证。在生产环境中，应考虑以下安全增强措施：

1. 添加身份验证和授权系统
2. 实现请求限流防止滥用
3. 使用SSL/TLS加密API通信
4. 从LowDB迁移到更强大的数据库（如MongoDB或PostgreSQL）
5. 实现输入验证和清洁

## 未来扩展

系统设计允许以下扩展：

1. **AI集成**: 将真实AI服务集成到处理器节点中
2. **更多节点类型**: 添加输入、输出、逻辑分支等节点类型
3. **用户系统**: 添加多用户支持，包括权限和共享功能
4. **版本控制**: 为流程图添加版本历史和回滚功能
5. **导入/导出**: 支持流程图的导入导出功能

## 启动和运行

要启动后端服务器，可以使用以下命令：

```bash
# 安装依赖
npm install

# 开发模式（同时运行前端和后端）
npm run dev

# 仅运行后端服务器
npm run server
```

后端服务器默认在 http://localhost:3001 上运行。
